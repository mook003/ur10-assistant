import re
import speech_recognition as sr


class FastToolAssistant:
    """
    –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.
    """

    def __init__(self):
        self.recognizer = sr.Recognizer()
        self.microphone = sr.Microphone()

        # –°–ª–æ–≤–∞—Ä—å –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ‚Üí —Å–ø–∏—Å–æ–∫ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
        self.tools_dict = {
            "–º–æ–ª–æ—Ç–æ–∫": ["–º–æ–ª–æ—Ç–æ–∫", "–º–æ–ª–æ—Ç", "–∫—É–≤–∞–ª–¥–∞"],
            "–æ—Ç–≤–µ—Ä—Ç–∫–∞": ["–æ—Ç–≤–µ—Ä—Ç–∫–∞", "–æ—Ç–≤–µ—Ä—Ç–æ—á–∫–∞"],
            "–≥–∞–µ—á–Ω—ã–π –∫–ª—é—á": ["–≥–∞–µ—á–Ω—ã–π –∫–ª—é—á", "–∫–ª—é—á"],
            "–ø–ª–æ—Å–∫–æ–≥—É–±—Ü—ã": ["–ø–ª–æ—Å–∫–æ–≥—É–±—Ü—ã", "–ø–∞—Å—Å–∞—Ç–∏–∂–∏"],
            "–Ω–æ–∂–æ–≤–∫–∞": ["–Ω–æ–∂–æ–≤–∫–∞", "–ø–∏–ª–∞"],
            "—Ä—É–ª–µ—Ç–∫–∞": ["—Ä—É–ª–µ—Ç–∫–∞", "–º–µ—Ç—Ä"],
            "–¥—Ä–µ–ª—å": ["–¥—Ä–µ–ª—å", "–ø–µ—Ä—Ñ–æ—Ä–∞—Ç–æ—Ä"],
            "—Å—Ç–∞–º–µ—Å–∫–∞": ["—Å—Ç–∞–º–µ—Å–∫–∞", "–¥–æ–ª–æ—Ç–æ"],
            "—É—Ä–æ–≤–µ–Ω—å": ["—É—Ä–æ–≤–µ–Ω—å", "–≤–∞—Ç–µ—Ä–ø–∞—Å"],
            "–Ω–æ–∂": ["–Ω–æ–∂", "—Ä–µ–∑–∞–∫"],
        }

        # –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        self.compiled_patterns = {
            tool: re.compile(r"\b(" + "|".join(words) + r")\b", re.IGNORECASE)
            for tool, words in self.tools_dict.items()
        }

    # ----------------------------------------------------------------------
    def fast_find_tool(self, text: str):
        """
        –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
        """
        text = text.lower()
        found_tools = []

        print(f"üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É: '{text}'")

        for tool, pattern in self.compiled_patterns.items():
            match = pattern.search(text)
            if match:
                print(f"   ‚Üí –Ω–∞–π–¥–µ–Ω–æ: '{match.group(1)}' ‚Üí –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '{tool}'")
                found_tools.append(tool)

        return found_tools

    # ----------------------------------------------------------------------
    def record_and_process(self):
        """
        –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        ("exit", []) ‚Äî –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è,
        ("continue", [—Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤]) ‚Äî –µ—Å–ª–∏ –≤—Å–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
        """
        print("\n" + "=" * 50)
        command = self.record_and_recognize()

        if not command:
            return "continue", []

        print(f"üìã –ü–æ–ª—É—á–µ–Ω–æ: '{command}'")

        if any(word in command for word in ("—Å—Ç–æ–ø", "–≤—ã—Ö–æ–¥", "—Ö–≤–∞—Ç–∏—Ç")):
            print("üõë –ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞.")
            return "exit", []

        return "continue", self.fast_find_tool(command)

    # ----------------------------------------------------------------------
    def record_and_recognize(self) -> str:
        """
        –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å, –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ.
        """
        with self.microphone:
            self.recognizer.adjust_for_ambient_noise(self.microphone, duration=1)

            try:
                print("üé§ –°–ª—É—à–∞—é... (–≥–æ–≤–æ—Ä–∏—Ç–µ)")
                audio = self.recognizer.listen(self.microphone, timeout=5, phrase_time_limit=5)

                print("‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞—é...")
                return self.recognizer.recognize_google(audio, language="ru").lower()

            except sr.UnknownValueError:
                print("‚ùå –†–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞.")
            except sr.RequestError as error:
                print(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {error}")
            except sr.WaitTimeoutError:
                print("‚ùå –¢–∞–π–º–∞—É—Ç: –Ω–∏—á–µ–≥–æ –Ω–µ —Å–∫–∞–∑–∞–Ω–æ.")
            except Exception as error:
                print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {error}")

            return ""

    # ----------------------------------------------------------------------
    def show_available_tools(self):
        """–í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤."""
        print("\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
        for idx, (tool, words) in enumerate(self.tools_dict.items(), start=1):
            joined = ", ".join(words)
            print(f"{idx:2d}. {tool:15} ‚Üí {joined}")


# ----------------------------------------------------------------------
if __name__ == "__main__":
    assistant = FastToolAssistant()

    print("üîß –ë–´–°–¢–†–´–ô –ì–û–õ–û–°–û–í–û–ô –ü–û–ú–û–©–ù–ò–ö –î–õ–Ø –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í")
    print("=" * 50)

    try:
        while True:
            status, tools_found = assistant.record_and_process()

            if status == "exit":
                print("\nüëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")
                break

            if tools_found:
                print(f"üéØ –ù–∞–π–¥–µ–Ω—ã: {', '.join(tools_found)}")
            else:
                print("üí° –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")

            print("\n–ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–∞–Ω–¥–µ...")

    except KeyboardInterrupt:
        print("\n\nüëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
